server {
    listen 80;
    server_name bureung.site www.bureung.site;
    
    # OAuth 경로를 백엔드로 프록시 (맨 먼저 설정)
    location /oauth2/ {
        proxy_pass http://spring-backend:8080/oauth2/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    location /login/oauth2/ {
        proxy_pass http://spring-backend:8080/login/oauth2/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # 백엔드 API - 가장 구체적인 경로를 먼저 설정
    location /api/ {
        proxy_pass http://spring-backend:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # 대시보드 API
    location /api/companion/dashboard {
        proxy_pass http://spring-backend:8080/companion/dashboard;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # 게임 리스트 API
    location = /companion/games/list {
        proxy_pass http://spring-backend:8080/companion/games/list;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # recorder/game API들 (쿼리 파라미터 포함)
    location ~ ^/recorder/game/(.+)$ {
        proxy_pass http://spring-backend:8080/recorder/game/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # 백엔드 companion API
    location /companion/user/ {
        proxy_pass http://spring-backend:8080/companion/user/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    location /companion/game/ {
        proxy_pass http://spring-backend:8080/companion/game/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    location /companion/record/ {
        proxy_pass http://spring-backend:8080/companion/record/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # 백엔드 recorder API
    location /recorder/user/ {
        proxy_pass http://spring-backend:8080/recorder/user/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # ✅ 수정: recorder/record API만 백엔드로 (정확한 API 경로들만)
    location ~ ^/recorder/record/(create|today-exists)$ {
        proxy_pass http://spring-backend:8080$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }
    
    # ✅ 추가: recorder/record/list API (쿼리 파라미터 포함)
    location = /recorder/record/list {
        if ($args) {
            proxy_pass http://spring-backend:8080$request_uri;
            break;
        }
        # 쿼리 파라미터가 없으면 React 페이지로
        proxy_pass http://react-frontend:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 그 외 모든 경로는 React 앱으로 (맨 마지막에 설정)
    location / {
        proxy_pass http://react-frontend:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}